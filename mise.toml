[tools]
go = "1.24"

[tasks.build]
description = "Build the server binary"
run = "go build -o dubly ./cmd/server"
sources = ["**/*.go", "go.mod", "go.sum"]
outputs = ["dubly"]

[tasks.run]
description = "Run the server"
depends = ["build"]
run = "./dubly"

[tasks.dev]
description = "Run the server with go run (no binary)"
run = "go run ./cmd/server"

[tasks.test]
description = "Run all tests"
run = "go test ./internal/... -count=1"

[tasks."test:verbose"]
description = "Run all tests with verbose output"
run = "go test ./internal/... -v -count=1"

[tasks."test:cover"]
description = "Run tests with coverage report"
run = [
  "go test ./internal/... -coverprofile=coverage.out -count=1",
  "go tool cover -func=coverage.out",
]

[tasks."test:cover:html"]
description = "Open coverage report in browser"
depends = ["test:cover"]
run = "go tool cover -html=coverage.out"

[tasks.fmt]
description = "Format all Go files"
run = "gofmt -w ."

[tasks."fmt:check"]
description = "Check formatting without writing"
run = "test -z \"$(gofmt -l .)\""

[tasks.vet]
description = "Run go vet"
run = "go vet ./..."

[tasks.lint]
description = "Run all linters (fmt check + vet)"
depends = ["fmt:check", "vet"]

[tasks.check]
description = "Run lint and tests"
depends = ["lint", "test"]

[tasks.clean]
description = "Remove build artifacts"
run = "rm -f dubly coverage.out"

[tasks.serve]
description = "Run dev server"
run = "DUBLY_PASSWORD=test DUBLY_DOMAINS=localhost DUBLY_DB_PATH=./dubly.db go run ./cmd/server"

[tasks.start]
description = "Build, restore (if needed), and run under Litestream"
run = "./scripts/start.sh"

[tasks.restore]
description = "Restore SQLite database from S3 replica"
run = "litestream restore -config litestream.yml -if-replica-exists ${DUBLY_DB_PATH:-./dubly.db}"

[tasks.bench]
description = "Run redirect throughput benchmark (50 workers, 10s)"
run = "go run ./cmd/bench -c 50 -d 10s"

[tasks."bench:quick"]
description = "Quick benchmark sanity check (10 workers, 3s)"
run = "go run ./cmd/bench -c 10 -d 3s"

[tasks."bench:heavy"]
description = "Heavy load benchmark (100 workers, 30s)"
run = "go run ./cmd/bench -c 100 -d 30s"
