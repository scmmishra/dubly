{{define "title"}}Admin{{end}}

{{define "content"}}
<div class="dash-grid">
    <div class="dash-stats">
        <div class="dash-stat">
            <span class="dash-stat-label">Active links</span>
            <span class="dash-stat-number mono">{{formatNum .TotalLinks}}</span>
        </div>
        <div class="dash-stat">
            <span class="dash-stat-label">Today</span>
            <span class="dash-stat-number mono">{{formatNum .ClicksToday}}</span>
        </div>
        <div class="dash-stat">
            <span class="dash-stat-label">Total clicks</span>
            <span class="dash-stat-number mono">{{formatNum .ClicksAllTime}}</span>
        </div>
    </div>
    <div class="dash-referrers">
        <div class="dash-tabs">
            <button class="dash-tab active" data-tab="referrers">Referrers</button>
            <button class="dash-tab" data-tab="countries">Countries</button>
            <button class="dash-tab" data-tab="browsers">Browsers</button>
            <button class="dash-tab" data-tab="devices">Devices</button>
        </div>
        <div class="dash-tab-panel active" data-panel="referrers">
            {{if .TopReferrers}}
            <div class="al-rows">
                {{range .TopReferrers}}
                <div class="al-row">
                    <span class="al-row-label mono">{{.Domain}}</span>
                    <span class="al-row-count mono">{{formatNum .Count}}</span>
                </div>
                {{end}}
            </div>
            {{else}}
            <p class="empty-state">No referrer data yet.</p>
            {{end}}
        </div>
        <div class="dash-tab-panel" data-panel="countries">
            {{if .TopCountries}}
            <div class="al-rows">
                {{range .TopCountries}}
                <div class="al-row">
                    <span class="al-row-label">{{countryFlag .Country}} {{.Country}}</span>
                    <span class="al-row-count mono">{{formatNum .Count}}</span>
                </div>
                {{end}}
            </div>
            {{else}}
            <p class="empty-state">No country data yet.</p>
            {{end}}
        </div>
        <div class="dash-tab-panel" data-panel="browsers">
            {{if .TopBrowsers}}
            <div class="al-rows">
                {{range .TopBrowsers}}
                <div class="al-row">
                    <span class="al-row-label">{{.Browser}}</span>
                    <span class="al-row-count mono">{{formatNum .Count}}</span>
                </div>
                {{end}}
            </div>
            {{else}}
            <p class="empty-state">No browser data yet.</p>
            {{end}}
        </div>
        <div class="dash-tab-panel" data-panel="devices">
            {{if .TopDevices}}
            <div class="al-rows">
                {{range .TopDevices}}
                <div class="al-row">
                    <span class="al-row-label">{{title .DeviceType}}</span>
                    <span class="al-row-count mono">{{formatNum .Count}}</span>
                </div>
                {{end}}
            </div>
            {{else}}
            <p class="empty-state">No device data yet.</p>
            {{end}}
        </div>
    </div>
</div>

<div class="search-bar">
    <input
        type="search"
        name="search"
        class="input search-input"
        placeholder="Search links..."
        value="{{.Search}}"
        hx-get="/admin"
        hx-trigger="input changed delay:300ms, search"
        hx-target="#link-cards"
        hx-push-url="true"
        hx-include="this"
    >
    <div class="view-toggle">
        <button type="button" class="view-toggle-btn active" data-view="grid" title="Grid view">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1" width="6" height="6" rx="1.5"/><rect x="9" y="1" width="6" height="6" rx="1.5"/><rect x="1" y="9" width="6" height="6" rx="1.5"/><rect x="9" y="9" width="6" height="6" rx="1.5"/></svg>
        </button>
        <button type="button" class="view-toggle-btn" data-view="list" title="List view">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><rect x="1" y="1.5" width="14" height="3" rx="1.5"/><rect x="1" y="6.5" width="14" height="3" rx="1.5"/><rect x="1" y="11.5" width="14" height="3" rx="1.5"/></svg>
        </button>
    </div>
</div>

<div id="link-cards">
    {{template "cards" .}}
</div>

<script>
(function() {
    var key = 'dubly_view';
    var saved = localStorage.getItem(key) || 'grid';
    var btns = document.querySelectorAll('.view-toggle-btn');

    function apply(view) {
        var grid = document.getElementById('link-grid');
        if (!grid) return;
        if (view === 'list') {
            grid.classList.add('view-list');
        } else {
            grid.classList.remove('view-list');
        }
        btns.forEach(function(b) {
            b.classList.toggle('active', b.getAttribute('data-view') === view);
        });
        localStorage.setItem(key, view);
    }

    apply(saved);

    btns.forEach(function(b) {
        b.addEventListener('click', function() { apply(b.getAttribute('data-view')); });
    });

    // Re-apply after HTMX settles new content
    document.addEventListener('htmx:afterSettle', function() { apply(localStorage.getItem(key) || 'grid'); });
})();

// Dashboard tabs
(function() {
    document.querySelectorAll('.dash-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            var target = tab.getAttribute('data-tab');
            var container = tab.closest('.dash-referrers');
            container.querySelectorAll('.dash-tab').forEach(function(t) { t.classList.remove('active'); });
            container.querySelectorAll('.dash-tab-panel').forEach(function(p) { p.classList.remove('active'); });
            tab.classList.add('active');
            container.querySelector('[data-panel="' + target + '"]').classList.add('active');
        });
    });
})();
</script>
{{end}}
