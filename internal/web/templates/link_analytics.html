{{define "title"}}{{.Link.ShortURL}}{{end}}

{{define "content"}}
{{if not .Link.IsActive}}
<div class="flash flash-error">This link is inactive and returns HTTP 410 (Gone).</div>
{{end}}

<a href="/admin" class="al-back">&larr; Back</a>

<div class="al-header">
    <div class="al-header-left">
        <h1 class="al-url mono">{{.Link.ShortURL}}
            <button class="btn-qr" id="qr-open" type="button" title="QR Code">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="2" y="2" width="8" height="8" rx="1"/><rect x="14" y="2" width="8" height="8" rx="1"/><rect x="2" y="14" width="8" height="8" rx="1"/>
                    <path d="M14 14h2v2h-2zm4 0h2v2h-2zm-4 4h2v2h-2zm4 0h2v2h-2z"/>
                </svg>
            </button>
        </h1>
        <a href="{{.Link.Destination}}" target="_blank" rel="noopener" class="al-dest mono">{{truncate .Link.Destination 70}}</a>
        {{if .Link.Title}}<p class="al-link-title">{{.Link.Title}}</p>{{end}}
    </div>
    <div class="al-header-right">
        <a href="{{.Link.ShortURL}}" target="_blank" rel="noopener" class="btn btn-ghost">Visit</a>
        <a href="/admin/links/{{.Link.ID}}/edit" class="btn btn-primary">Edit</a>
        {{if .Link.IsActive}}
        <button
            class="btn btn-destructive"
            hx-delete="/admin/links/{{.Link.ID}}"
            hx-confirm="Delete this link?"
            hx-target="body"
            hx-swap="none"
            hx-on::after-request="if(event.detail.successful) window.location='/admin'"
        >Delete</button>
        {{end}}
    </div>
</div>

<div class="al-hero">
    <div class="al-hero-stat">
        <span class="al-hero-number mono">{{formatNum .TotalClicks}}</span>
        <span class="al-hero-label">Total clicks</span>
    </div>
    <div class="al-hero-stat">
        <span class="al-hero-number mono">{{formatNum .ClicksToday}}</span>
        <span class="al-hero-label">Today</span>
    </div>
    <div class="al-hero-stat">
        <span class="al-hero-number mono">{{formatNum .ClicksThisWeek}}</span>
        <span class="al-hero-label">This week{{if gt .ClicksPrevWeek 0}} <span class="al-hero-change {{if .WeekChangeUp}}al-change-up{{else}}al-change-down{{end}}">{{if .WeekChangeUp}}+{{end}}{{.WeekChange}}%</span>{{end}}</span>
    </div>
</div>

<div class="al-meta">
    <span class="al-meta-item">Created {{timeAgo .Link.CreatedAt}}</span>
    {{if .Link.Tags}}<span class="al-meta-item al-meta-has-dot">{{spaceTags .Link.Tags}}</span>{{end}}
</div>

<div class="al-grid">
    <div class="card al-breakdown">
        <h2 class="card-title">Top referrers</h2>
        {{if .TopReferrers}}
        <div class="al-rows">
            {{range .TopReferrers}}
            <div class="al-row">
                <span class="al-row-label mono">{{.Domain}}</span>
                <span class="al-row-count mono">{{formatNum .Count}}</span>
            </div>
            {{end}}
        </div>
        {{else}}
        <p class="empty-state">No referrer data yet.</p>
        {{end}}
    </div>

    <div class="card al-breakdown">
        <h2 class="card-title">Top countries</h2>
        {{if .TopCountries}}
        <div class="al-rows">
            {{range .TopCountries}}
            <div class="al-row">
                <span class="al-row-label">{{countryFlag .Country}} {{.Country}}</span>
                <span class="al-row-count mono">{{formatNum .Count}}</span>
            </div>
            {{end}}
        </div>
        {{else}}
        <p class="empty-state">No country data yet.</p>
        {{end}}
    </div>

    <div class="card al-breakdown">
        <h2 class="card-title">Top browsers</h2>
        {{if .TopBrowsers}}
        <div class="al-rows">
            {{range .TopBrowsers}}
            <div class="al-row">
                <span class="al-row-label">{{.Browser}}</span>
                <span class="al-row-count mono">{{formatNum .Count}}</span>
            </div>
            {{end}}
        </div>
        {{else}}
        <p class="empty-state">No browser data yet.</p>
        {{end}}
    </div>

    <div class="card al-breakdown">
        <h2 class="card-title">Devices</h2>
        {{if .TopDevices}}
        <div class="al-rows">
            {{range .TopDevices}}
            <div class="al-row">
                <span class="al-row-label">{{title .DeviceType}}</span>
                <span class="al-row-count mono">{{formatNum .Count}}</span>
            </div>
            {{end}}
        </div>
        {{else}}
        <p class="empty-state">No device data yet.</p>
        {{end}}
    </div>
</div>

<!-- QR Code Modal -->
<div class="qr-overlay" id="qr-overlay" hidden>
    <div class="qr-modal">
        <button class="qr-close" id="qr-close" type="button">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></svg>
        </button>
        <div class="qr-col-preview">
            <div class="qr-col-preview-inner">
                <img id="qr-img" src="/admin/links/{{.Link.ID}}/qr" alt="QR Code">
            </div>
        </div>
        <div class="qr-col-options">
            <div class="qr-opt">
                <span class="qr-opt-label">Shape</span>
                <div class="qr-shape-btns">
                    <button class="qr-shape-btn active" data-shape="square" type="button">Square</button>
                    <button class="qr-shape-btn" data-shape="circle" type="button">Circle</button>
                </div>
            </div>
            <div class="qr-opt">
                <span class="qr-opt-label">Color</span>
                <div class="qr-swatches">
                    <button class="qr-swatch active" data-fg="#000000" type="button" style="background:#000000" title="Black"></button>
                    <button class="qr-swatch" data-fg="#2563eb" type="button" style="background:#2563eb" title="Blue"></button>
                    <button class="qr-swatch" data-fg="#16a34a" type="button" style="background:#16a34a" title="Green"></button>
                    <button class="qr-swatch" data-fg="#dc2626" type="button" style="background:#dc2626" title="Red"></button>
                    <button class="qr-swatch" data-fg="#9333ea" type="button" style="background:#9333ea" title="Purple"></button>
                    <label class="qr-swatch qr-swatch-custom" title="Custom">
                        <input type="color" id="qr-fg" value="#000000">
                    </label>
                </div>
            </div>
            <div class="qr-opt qr-actions">
                <button class="btn btn-ghost btn-sm" id="qr-copy" type="button">Copy</button>
                <a class="btn btn-primary btn-sm" id="qr-download" href="/admin/links/{{.Link.ID}}/qr?dl=1" download>Download PNG</a>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    var linkId = {{.Link.ID}};
    var basePath = '/admin/links/' + linkId + '/qr';
    var state = { shape: 'square', fg: '#000000' };

    var overlay = document.getElementById('qr-overlay');
    var img = document.getElementById('qr-img');
    var dlLink = document.getElementById('qr-download');
    var fgInput = document.getElementById('qr-fg');

    function buildURL(dl) {
        var params = [];
        if (state.shape === 'circle') params.push('shape=circle');
        if (state.fg !== '#000000') params.push('fg=' + encodeURIComponent(state.fg));
        if (dl) params.push('dl=1');
        return basePath + (params.length ? '?' + params.join('&') : '');
    }

    function refresh() {
        img.src = buildURL(false);
        dlLink.href = buildURL(true);
    }

    // Open / close
    document.getElementById('qr-open').addEventListener('click', function() {
        overlay.hidden = false;
        refresh();
    });
    document.getElementById('qr-close').addEventListener('click', function() {
        overlay.hidden = true;
    });
    overlay.addEventListener('click', function(e) {
        if (e.target === overlay) overlay.hidden = true;
    });
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !overlay.hidden) overlay.hidden = true;
    });

    // Shape toggle
    document.querySelectorAll('.qr-shape-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.qr-shape-btn').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.shape = btn.dataset.shape;
            refresh();
        });
    });

    // Color swatches
    document.querySelectorAll('.qr-swatch').forEach(function(btn) {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.qr-swatch').forEach(function(b) { b.classList.remove('active'); });
            btn.classList.add('active');
            state.fg = btn.dataset.fg;
            fgInput.value = state.fg;
            refresh();
        });
    });

    // Custom color picker
    var customSwatch = document.querySelector('.qr-swatch-custom');
    fgInput.addEventListener('input', function() {
        state.fg = fgInput.value;
        document.querySelectorAll('.qr-swatch').forEach(function(b) { b.classList.remove('active'); });
        customSwatch.classList.add('active');
        refresh();
    });

    // Copy to clipboard
    document.getElementById('qr-copy').addEventListener('click', function() {
        var btn = this;
        fetch(buildURL(false))
            .then(function(r) { return r.blob(); })
            .then(function(blob) {
                return navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
            })
            .then(function() {
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = 'Copy'; }, 1500);
            })
            .catch(function() {
                btn.textContent = 'Failed';
                setTimeout(function() { btn.textContent = 'Copy'; }, 1500);
            });
    });
})();
</script>
{{end}}
